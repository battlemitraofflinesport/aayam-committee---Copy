<section class="container my-5">
  <h3 class="text-center mb-4">âœ Edit Team Member</h3>

  <form
    action="/team/member/edit/<%= member.id %>"
    method="POST"
    enctype="multipart/form-data"
    class="mx-auto"
    style="max-width: 400px;"
  >

    <!-- MEMBER NAME -->
    <div class="mb-3">
      <label class="form-label">Member Name</label>
      <input
        type="text"
        name="name"
        value="<%= member.name %>"
        class="form-control"
        required
      />
    </div>

    <!-- POSITION -->
    <div class="mb-3">
      <label class="form-label">Position</label>
      <input
        type="text"
        name="position"
        value="<%= member.position || '' %>"
        class="form-control"
      />
    </div>

    <!-- SECTION -->
    <div class="mb-3">
      <label class="form-label">Section</label>
      <select name="section_id" class="form-control" required>
        <% sections.forEach(section => { %>
          <option value="<%= section.id %>" <%= member.section_id === section.id ? 'selected' : '' %>>
            <%= section.title %>
          </option>
        <% }) %>
      </select>
    </div>

    <!-- MEMBER IMAGE (OPTIONAL) -->
    <div class="mb-3">
      <label class="form-label">Change Image (optional)</label>
      <input
        type="file"
        name="image"
        class="form-control"
        accept="image/*"
      />
    </div>

    <button type="submit" class="btn btn-dark w-100">
      ğŸ’¾ Save Changes
    </button>
  </form>
</section>

<!-- Client Side Image Compression -->
<script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.1/dist/browser-image-compression.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const editForm = document.querySelector('form[action^="/team/member/edit/"]');
    if (!editForm) return;

    editForm.addEventListener('submit', async function(e) {
      const fileInput = editForm.querySelector('input[type="file"]');
      const file = fileInput.files[0];

      if (!file) return; // No file, nothing to compress

      // Prevent default submission to compress first
      e.preventDefault();
      const submitBtn = editForm.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = 'â³ Compressing Image...';

      try {
        const options = {
          maxSizeMB: 1,
          maxWidthOrHeight: 1024,
          useWebWorker: true
        };

        const compressedFile = await imageCompression(file, options);
        console.log(`Original: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
        console.log(`Compressed: ${(compressedFile.size / 1024 / 1024).toFixed(2)} MB`);

        // Replace file in input
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(new File([compressedFile], file.name, {
          type: compressedFile.type,
          lastModified: Date.now()
        }));
        
        fileInput.files = dataTransfer.files;

        // Submit form
        submitBtn.innerHTML = 'â¬† Uploading...';
        editForm.submit();

      } catch (error) {
        console.error('Error compressing image:', error);
        alert('Failed to compress image. Proceeding with original upload attempt.');
        editForm.submit(); // Try to submit anyway
      } finally {
        // Just in case it fails, re-enable
        setTimeout(() => {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }, 5000);
      }
    });
  });
</script>
