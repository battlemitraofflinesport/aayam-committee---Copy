<section class="container my-5">
  <h3 class="text-center mb-4">‚úè Edit Team Member</h3>

  <form
    action="/team/member/edit/<%= member.id %>"
    method="POST"
    enctype="multipart/form-data"
    class="mx-auto"
    style="max-width: 400px;"
  >

    <!-- MEMBER NAME -->
    <div class="mb-3">
      <label class="form-label">Member Name</label>
      <input
        type="text"
        name="name"
        value="<%= member.name %>"
        class="form-control"
        required
      />
    </div>

    <!-- POSITION -->
    <div class="mb-3">
      <label class="form-label">Position</label>
      <select name="position" class="form-control" id="edit-position" required>
        <option value="">Select Position...</option>
        <% sections.forEach(section => { %>
          <% if (section.id == member.section) { %>
            <% if (section.title.includes("Organizing Team")) { %>
              <option value="PRESIDENT" <%= member.position === "PRESIDENT" ? 'selected' : '' %>>PRESIDENT</option>
              <option value="VICE PRESIDENT" <%= member.position === "VICE PRESIDENT" ? 'selected' : '' %>>VICE PRESIDENT</option>
            <% } else if (section.title.includes("Management Department")) { %>
              <option value="CHAIRPERSON" <%= member.position === "CHAIRPERSON" ? 'selected' : '' %>>CHAIRPERSON</option>
              <option value="VICE CHAIRPERSON" <%= member.position === "VICE CHAIRPERSON" ? 'selected' : '' %>>VICE CHAIRPERSON</option>
              <option value="SECRETARY" <%= member.position === "SECRETARY" ? 'selected' : '' %>>SECRETARY</option>
              <option value="VICE SECRETARY" <%= member.position === "VICE SECRETARY" ? 'selected' : '' %>>VICE SECRETARY</option>
            <% } else if (section.title.includes("Media Department")) { %>
              <option value="CHAIRPERSON" <%= member.position === "CHAIRPERSON" ? 'selected' : '' %>>CHAIRPERSON</option>
              <option value="SOCIAL MEDIA HEAD" <%= member.position === "SOCIAL MEDIA HEAD" ? 'selected' : '' %>>SOCIAL MEDIA HEAD</option>
              <option value="PHOTOGRAPHY HEAD" <%= member.position === "PHOTOGRAPHY HEAD" ? 'selected' : '' %>>PHOTOGRAPHY HEAD</option>
            <% } else if (section.title.includes("Technical Department")) { %>
              <option value="CHAIRPERSON" <%= member.position === "CHAIRPERSON" ? 'selected' : '' %>>CHAIRPERSON</option>
              <option value="CHAIRPERSON" <%= member.position === "CHAIRPERSON" ? 'selected' : '' %>>CHAIRPERSON</option>
              <option value="SECRETARY" <%= member.position === "SECRETARY" ? 'selected' : '' %>>SECRETARY</option>
              <option value="DEVELOPER" <%= member.position === "DEVELOPER" ? 'selected' : '' %>>DEVELOPER</option>
            <% } else if (section.title.includes("Sports Department")) { %>
              <option value="SPORTS & CULTURAL CHAIRPERSON" <%= member.position === "SPORTS & CULTURAL CHAIRPERSON" ? 'selected' : '' %>>SPORTS & CULTURAL CHAIRPERSON</option>
              <option value="SPORTS CHAIRPERSON" <%= member.position === "SPORTS CHAIRPERSON" ? 'selected' : '' %>>SPORTS CHAIRPERSON</option>
              <option value="SPORTS VICE CHAIRPERSON" <%= member.position === "SPORTS VICE CHAIRPERSON" ? 'selected' : '' %>>SPORTS VICE CHAIRPERSON</option>
              <option value="SPORTS SECRETARY" <%= member.position === "SPORTS SECRETARY" ? 'selected' : '' %>>SPORTS SECRETARY</option>
            <% } else if (section.title.includes("Cultural Department")) { %>
              <option value="CULTURAL CHAIRPERSON" <%= member.position === "CULTURAL CHAIRPERSON" ? 'selected' : '' %>>CULTURAL CHAIRPERSON</option>
              <option value="VICE CHAIRPERSON" <%= member.position === "VICE CHAIRPERSON" ? 'selected' : '' %>>VICE CHAIRPERSON</option>
            <% } else if (section.title.includes("Discipline Department")) { %>
              <option value="HEAD" <%= member.position === "HEAD" ? 'selected' : '' %>>HEAD</option>
              <option value="VICE HEAD" <%= member.position === "VICE HEAD" ? 'selected' : '' %>>VICE HEAD</option>
              <option value="SECRETARY" <%= member.position === "SECRETARY" ? 'selected' : '' %>>SECRETARY</option>
              <option value="VICE SECRETARY" <%= member.position === "VICE SECRETARY" ? 'selected' : '' %>>VICE SECRETARY</option>
            <% } else { %>
              <option value="MEMBER" <%= member.position === "MEMBER" ? 'selected' : '' %>>MEMBER</option>
            <% } %>
          <% } %>
        <% }) %>
      </select>
    </div>

    <!-- SECTION -->
    <div class="mb-3">
      <label class="form-label">Section</label>
      <select name="section_id" class="form-control" id="edit-section" required onchange="updateEditPositions()">
        <% sections.forEach(section => { %>
          <option value="<%= section.id %>" <%= member.section === section.id ? 'selected' : '' %>>
            <%= section.title %>
          </option>
        <% }) %>
      </select>
    </div>

    <!-- MEMBER IMAGE (OPTIONAL) -->
    <div class="mb-3">
      <label class="form-label">Change Image (optional)</label>
      <input
        type="file"
        name="image"
        class="form-control"
        accept="image/*"
      />
    </div>

    <button type="submit" class="btn btn-dark w-100">
      üíæ Save Changes
    </button>
  </form>
</section>

<!-- Client Side Image Compression -->
<script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.1/dist/browser-image-compression.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const editForm = document.querySelector('form[action^="/team/member/edit/"]');
    if (!editForm) return;

    editForm.addEventListener('submit', async function(e) {
      const fileInput = editForm.querySelector('input[type="file"]');
      const file = fileInput.files[0];

      if (!file) return; // No file, nothing to compress

      // Prevent default submission to compress first
      e.preventDefault();
      const submitBtn = editForm.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '‚è≥ Compressing Image...';

      try {
        const options = {
          maxSizeMB: 1,
          maxWidthOrHeight: 1024,
          useWebWorker: true
        };

        const compressedFile = await imageCompression(file, options);
        console.log(`Original: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
        console.log(`Compressed: ${(compressedFile.size / 1024 / 1024).toFixed(2)} MB`);

        // Replace file in input
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(new File([compressedFile], file.name, {
          type: compressedFile.type,
          lastModified: Date.now()
        }));
        
        fileInput.files = dataTransfer.files;

        // Submit form
        submitBtn.innerHTML = '‚¨Ü Uploading...';
        editForm.submit();

      } catch (error) {
        console.error('Error compressing image:', error);
        alert('Failed to compress image. Proceeding with original upload attempt.');
        editForm.submit(); // Try to submit anyway
      } finally {
        // Just in case it fails, re-enable
        setTimeout(() => {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }, 5000);
      }
    });
  });

  // Function to update position dropdown based on section
  function updateEditPositions() {
    const sectionSelect = document.getElementById('edit-section');
    const positionSelect = document.getElementById('edit-position');
    const selectedSection = sectionSelect.options[sectionSelect.selectedIndex].text;
    
    let positions = [];
    
    if (selectedSection.includes("Organizing Team")) {
      positions = ["PRESIDENT", "VICE PRESIDENT"];
    } else if (selectedSection.includes("Management Department")) {
      positions = ["CHAIRPERSON", "VICE CHAIRPERSON", "SECRETARY", "VICE SECRETARY"];
    } else if (selectedSection.includes("Media Department")) {
      positions = ["CHAIRPERSON", "SOCIAL MEDIA HEAD", "PHOTOGRAPHY HEAD"];
    } else if (selectedSection.includes("Technical Department")) {
      positions = ["CHAIRPERSON", "CHAIRPERSON", "SECRETARY", "DEVELOPER"];
    } else if (selectedSection.includes("Sports Department")) {
      positions = ["SPORTS & CULTURAL CHAIRPERSON", "SPORTS CHAIRPERSON", "SPORTS VICE CHAIRPERSON", "SPORTS SECRETARY"];
    } else if (selectedSection.includes("Cultural Department")) {
      positions = ["CULTURAL CHAIRPERSON", "VICE CHAIRPERSON"];
    } else if (selectedSection.includes("Discipline Department")) {
      positions = ["HEAD", "VICE HEAD", "SECRETARY", "VICE SECRETARY"];
    } else {
      positions = ["MEMBER"];
    }
    
    // Clear current options
    positionSelect.innerHTML = '<option value="">Select Position...</option>';
    
    // Add new options
    positions.forEach(position => {
      const option = document.createElement('option');
      option.value = position;
      option.textContent = position;
      positionSelect.appendChild(option);
    });
  }
</script>

