<!-- views/team.ejs -->
<div class="container">
  <div class="page-header" data-aos="fade-down">
    <div class="section-label">Meet The People</div>
    <h1 class="page-title">Our Team</h1>
    <p class="page-subtitle">The dedicated individuals driving AAYAM Committee forward</p>
  </div>

  <% sections.forEach((section, si)=> { %>
    <div class="team-section" data-aos="fade-up" data-aos-delay="<%= si * 60 %>">

      <h2 class="team-section-title">
        <%= section.title %>
      </h2>
      <div class="team-section-underline"></div>

      <% if (user && (user.role==="admin" || user.role==="superadmin" )) { %>
        <div class="text-center mb-4 d-flex gap-2 justify-content-center flex-wrap">
          <a href="/team/section/edit/<%= section.id %>" class="btn-details">✏ Edit Section</a>
          <form action="/team/section/delete/<%= section.id %>" method="POST" class="d-inline"
            onsubmit="return confirm('Delete this section and all its members?')">
            <button class="btn-admin-danger">✕ Delete Section</button>
          </form>
        </div>
        <% } %>

          <div class="row g-3 justify-content-center">
            <% if (section.members && section.members.length> 0) { %>
              <% section.members.forEach((member, mi)=> { %>
                <div class="col-xl-2 col-lg-3 col-md-4 col-6" data-aos="zoom-in" data-aos-delay="<%= mi * 55 %>">
                  <div class="team-member-card">
                    <div class="team-member-img-wrap">
                      <img src="<%= member.image %>" alt="<%= member.name %>" class="team-member-img">
                    </div>
                    <p class="team-member-name">
                      <%= member.name %>
                    </p>
                    <p class="team-member-position">
                      <%= member.position %>
                    </p>
                    <% if (user && (user.role==="admin" || user.role==="superadmin" )) { %>
                      <div class="d-flex gap-2 justify-content-center flex-wrap mt-1">
                        <a href="/team/member/edit/<%= member.id %>" class="btn-details"
                          style="font-size:0.78rem;padding:5px 12px;">✏ Edit</a>
                        <form action="/team/member/delete/<%= member.id %>" method="POST"
                          onsubmit="return confirm('Delete this member?')">
                          <button class="btn-admin-danger" style="font-size:0.78rem;padding:5px 12px;">✕</button>
                        </form>
                      </div>
                      <% } %>
                  </div>
                </div>
                <% }) %>
                  <% } else { %>
                    <div class="col-12 text-center" style="color:var(--tx-muted);padding:24px 0;">No members added yet.
                    </div>
                    <% } %>
          </div>

          <% if (user && (user.role==="admin" || user.role==="superadmin" )) { %>
            <div class="mt-4 d-flex justify-content-center">
              <details class="admin-add-form" style="max-width:480px;width:100%;">
                <summary style="cursor:pointer;font-weight:700;color:var(--br);list-style:none;padding:4px 0;">➕ Add
                  Member to this Section</summary>
                <form action="/team/member/add" method="POST" enctype="multipart/form-data"
                  class="mt-3 add-member-form">
                  <input type="hidden" name="section_id" value="<%= section.id %>">
                  <input type="text" name="name" placeholder="Member name" class="form-control mb-2" required>
                  
                  <!-- Position Dropdown based on section -->
                  <div class="mb-2">
                    <select name="position" class="form-control" required id="position-<%= section.id %>">
                      <option value="">Select Position...</option>
                      <% if (section.title.includes("Organizing Team")) { %>
                        <option value="PRESIDENT">PRESIDENT</option>
                        <option value="VICE PRESIDENT">VICE PRESIDENT</option>
                      <% } else if (section.title.includes("Management Department")) { %>
                        <option value="CHAIRPERSON">CHAIRPERSON</option>
                        <option value="VICE CHAIRPERSON">VICE CHAIRPERSON</option>
                        <option value="SECRETARY">SECRETARY</option>
                        <option value="VICE SECRETARY">VICE SECRETARY</option>
                      <% } else if (section.title.includes("Media Department")) { %>
                        <option value="CHAIRPERSON">CHAIRPERSON</option>
                        <option value="SOCIAL MEDIA HEAD">SOCIAL MEDIA HEAD</option>
                        <option value="PHOTOGRAPHY HEAD">PHOTOGRAPHY HEAD</option>
                      <% } else if (section.title.includes("Technical Department")) { %>
                        <option value="CHAIRPERSON">CHAIRPERSON</option>
                        <option value="CHAIRPERSON">CHAIRPERSON</option>
                        <option value="SECRETARY">SECRETARY</option>
                        <option value="DEVELOPER">DEVELOPER</option>
                      <% } else if (section.title.includes("Sports Department")) { %>
                        <option value="SPORTS & CULTURAL CHAIRPERSON">SPORTS & CULTURAL CHAIRPERSON</option>
                        <option value="SPORTS CHAIRPERSON">SPORTS CHAIRPERSON</option>
                        <option value="SPORTS VICE CHAIRPERSON">SPORTS VICE CHAIRPERSON</option>
                        <option value="SPORTS SECRETARY">SPORTS SECRETARY</option>
                      <% } else if (section.title.includes("Cultural Department")) { %>
                        <option value="CULTURAL CHAIRPERSON">CULTURAL CHAIRPERSON</option>
                        <option value="VICE CHAIRPERSON">VICE CHAIRPERSON</option>
                      <% } else if (section.title.includes("Discipline Department")) { %>
                        <option value="HEAD">HEAD</option>
                        <option value="VICE HEAD">VICE HEAD</option>
                        <option value="SECRETARY">SECRETARY</option>
                        <option value="VICE SECRETARY">VICE SECRETARY</option>
                      <% } else { %>
                        <option value="MEMBER">MEMBER</option>
                      <% } %>
                    </select>
                  </div>
                  
                  <input type="file" name="image" class="form-control mb-3" accept="image/*" required>
                  <button type="submit" class="btn-register w-100">⬆ Upload Member</button>
                </form>
              </details>
            </div>
            <% } %>

    </div>
    <% }) %>

      <% if (user && (user.role==="admin" || user.role==="superadmin" )) { %>
        <div class="text-center mt-5 pt-4" style="border-top:1px solid var(--border-l);" data-aos="fade-up">
          <h4 class="events-col-title mb-3">Add New Team Section</h4>
          <form action="/team/section/add" method="POST"
            class="d-inline-flex gap-2 align-items-center justify-content-center flex-wrap">
            <select name="title" class="form-control" style="max-width:280px;" required>
              <option value="">Select Section...</option>
              <option value="Organizing Team">Organizing Team</option>
              <option value="Management Department">Management Department</option>
              <option value="Media Department">Media Department</option>
              <option value="Technical Department">Technical Department</option>
              <option value="Sports Department">Sports Department</option>
              <option value="Cultural Department">Cultural Department</option>
              <option value="Discipline Department">Discipline Department</option>
            </select>
            <button type="submit" class="btn-register">➕ Add Section</button>
          </form>
        </div>
        <% } %>
</div>

<!-- Client Side Image Compression -->
<script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.1/dist/browser-image-compression.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const addForms = document.querySelectorAll('.add-member-form');

    addForms.forEach(form => {
      form.addEventListener('submit', async function (e) {
        const fileInput = form.querySelector('input[type="file"]');
        const file = fileInput.files[0];

        if (!file) return;

        e.preventDefault();
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '⏳ Compressing Image...';

        try {
          const options = {
            maxSizeMB: 1,
            maxWidthOrHeight: 1024,
            useWebWorker: true
          };

          const compressedFile = await imageCompression(file, options);
          console.log(`Original: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
          console.log(`Compressed: ${(compressedFile.size / 1024 / 1024).toFixed(2)} MB`);

          // Create a new File object and update the input
          const newFile = new File([compressedFile], file.name, {
            type: compressedFile.type,
            lastModified: Date.now()
          });

          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(newFile);
          fileInput.files = dataTransfer.files;

          submitBtn.innerHTML = '⬆ Uploading...';
          
          // Use actual form submission instead of form.submit()
          setTimeout(() => {
            form.removeEventListener('submit', arguments.callee);
            form.submit();
          }, 100);

        } catch (error) {
          console.error('Error compressing image:', error);
          submitBtn.innerHTML = '⬆ Uploading...';
          setTimeout(() => {
            form.removeEventListener('submit', arguments.callee);
            form.submit();
          }, 100);
        }
      });
    });
  });
</script>
